<?php
/*first we are going to validate.
if validation true we will wash data  and then insert data into db return to editBook page*/

$validationFailed = false;  /*A single place to track whether any validation has failed.*/


/*boilerplate over, now validate if needed.*/
/*if we didn't get sent back from page C, because Form B validation failed, validate form A submission*/
if(isset($_POST['bookTitle'])) { /*bookTitle can be set and have an empty value. submit sets booktitle even if it is empty*/
if($debug) {
echo "inside isset booktitle" . "<br/>";
}/*end debug*/

/* Perform all validations needed for all fields*/
if(empty($_POST['bookTitle'])){

$_SESSION['bookTitleErr'] = " * Book Title is required";
$validationFailed = true;
} /*end ifemptybookTitle*/


if (!empty($_POST['bookNum']) && (!is_numeric($_POST['bookNum'])))  {
$_SESSION['bookNumErr'] = " * Book Number must be a number";
$validationFailed = true;
} /*end if*/


/*Do I need to validate the other fields?*/



/*If any validation failed, save all form values in sessions*/
if($validationFailed) {
$_SESSION['addBookInfo_validationFailed'] = true;

$_SESSION['addBookInfo_bookTitle_value']= $_POST['bookTitle'];

$_SESSION['addBookInfo_tag1_value']= $_POST['tag1'];

$_SESSION['addBookInfo_tag2_value']= $_POST['tag2'];

$_SESSION['addBookInfo_bookVol_value']= $_POST['bookVol'];

$_SESSION['addBookInfo_bookNum_value']= $_POST['bookNum'];

$_SESSION['bookID'] = $_POST['bookID'];



} /*end if validationFailed*/

/*if pass validation save/insert and redirect to editBook.php
else save and make form*/

header('Location: addBookInfo.php');
exit();

if($debug) {
echo "before end if validationFailed" . "<br/>";
}/*end debug*/


if($debug) {
echo "before end if validation form A" . "<br/>";
}/*end debug*/

} /*end validation form A*/

/*if from add book info- insert book*/
/*if(!isset($_POST['tryAgainEdSearch']) && isset($_POST['searchEditorLastName']))  {*/
if(isset($_POST['bookTitle'])) {
if($debug) {
echo "Since this is a submission from addBookInfo, insert book info" . "<br/>";
}/*end debug*/

/*Validation over, now save form A Post values  in Database*/

$washPostVar = cleanup_post($_POST['bookTitle']);
$bookTitle = strip_before_insert($conn, $washPostVar);

if($debug) {
echo 'bookTitle =' . "$bookTitle" . '<br/>';
}/*end debug*/

$washPostVar = cleanup_post($_POST['tag1']);
$tag1 = strip_before_insert($conn, $washPostVar);

$washPostVar = cleanup_post($_POST['tag2']);
$tag2 = strip_before_insert($conn, $washPostVar);

$washPostVar = cleanup_post($_POST['bookVol']);
$bookVol = strip_before_insert($conn, $washPostVar);

$washPostVar = cleanup_post($_POST['bookNum']);
$bookNum = strip_before_insert($conn, $washPostVar);

/*Build the query string*/
$bookInsertQuery="INSERT INTO books (title, tag1, tag2, book_vol, book_num)
VALUES('$bookTitle', '$tag1', '$tag2', '$bookVol', $bookNum)";


/*Send the query to the database*/
$bookInsertQueryResult   = $conn->query($bookInsertQuery);
if($debug) {
echo("\nbookInsertQuery= " . $bookInsertQuery . "\n<br/>");
if (!$bookInsertQueryResult) echo("\n Error description bookInsertQuery: " . mysqli_error($conn) . "\n<br/>");
}/*end debug*/
/*Getting book ID for the book just inserted into database*/
$bookID = $conn->insert_id;

if($debug) {
echo("bookID = " . $bookID . "<br/>");
}/*end debug*/

} /*end  if post bookTitle (again)*/
if($debug) {
echo('we made it to hereA' . "\n<br/>");
}/*end debug*/

if(empty($bookID)){
$bookID = $_SESSION['bookID'];
}

?>